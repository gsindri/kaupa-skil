# Cart ChatPack 2025-09-12T11:42:16.706Z

_Contains 11 file(s)._

---

## src\components\cart\AddToCartButton.tsx

```tsx
import { Button } from '@/components/ui/button'
import { QuantityStepper } from './QuantityStepper'
import { useCart } from '@/contexts/useBasket'
import { useState } from 'react'
import {
  Select,
  SelectTrigger,
  SelectValue,
  SelectContent,
  SelectItem,
} from '@/components/ui/select'

interface AddToCartButtonProps {
  product: any
  vendors: { id: string; name: string }[]
}

export default function AddToCartButton({ product, vendors }: AddToCartButtonProps) {
  const { items, addItem, updateQuantity, removeItem } = useCart()
  const cartItem = items.find(i => i.supplierItemId === product.catalog_id)

  const [vendorId, setVendorId] = useState(
    vendors.length === 1 ? vendors[0].id : (product.suppliers?.[0]?.id as string | undefined)
  )

  if (cartItem) {
    return (
      <QuantityStepper
        quantity={cartItem.quantity}
        onChange={qty => updateQuantity(cartItem.supplierItemId, qty)}
        onRemove={() => removeItem(cartItem.supplierItemId)}
        label={product.name}
      />
    )
  }

  const handleAdd = () => {
    if (!vendorId) return
    addItem({ product_id: product.catalog_id, supplier_id: vendorId })
  }

  return (
    <div className="flex items-center gap-2">
      {vendors.length > 1 && (
        <Select value={vendorId} onValueChange={setVendorId}>
          <SelectTrigger className="w-[140px]" aria-label="Select vendor">
            <SelectValue placeholder="Select vendor" />
          </SelectTrigger>
          <SelectContent>
            {vendors.map(v => (
              <SelectItem key={v.id} value={v.id}>
                {v.name}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      )}
      <Button
        size="sm"
        onClick={handleAdd}
        aria-label={`Add ${product.name}`}
        disabled={!vendorId}
      >
        Add
      </Button>
    </div>
  )
}


```


---

## src\components\cart\CartDrawer.tsx

```tsx
import * as React from "react"
import { Sheet, SheetContent, SheetClose } from "@/components/ui/sheet"
import { Button } from "@/components/ui/button"
import { ScrollArea } from "@/components/ui/scroll-area"
import { Badge } from "@/components/ui/badge"
import { Trash2, X } from "lucide-react"
import { useCart } from "@/contexts/useBasket"
import { useSettings } from "@/contexts/useSettings"
import { QuantityStepper } from "./QuantityStepper"

export function CartDrawer() {
  const {
    items,
    updateQuantity,
    removeItem,
    getTotalPrice,
    getMissingPriceCount,
    isDrawerOpen,
    setIsDrawerOpen,
  } = useCart()
  const { includeVat, setIncludeVat } = useSettings()

  const subtotal = getTotalPrice(includeVat)
  const missingPriceCount = getMissingPriceCount()
  const formatCurrency = (n: number) =>
    new Intl.NumberFormat(undefined, {
      style: "currency",
      currency: "ISK",
      maximumFractionDigits: 0,
    }).format(n || 0)

  return (
    <Sheet open={isDrawerOpen} onOpenChange={setIsDrawerOpen}>
      <SheetContent
        side="right"
        className="w-[380px] max-w-[92vw] p-0 flex flex-col [&>button:last-child]:hidden"
        aria-label="Shopping cart"
        id="cart-drawer"
      >
        <div className="sticky top-0 z-10 bg-background/95 backdrop-blur border-b">
          <div className="flex items-center justify-between px-4 py-3">
            <div className="text-sm leading-tight">
              <span aria-live="polite" className="sr-only">
                Cart subtotal {formatCurrency(subtotal)}
              </span>
              <div className="text-muted-foreground">Subtotal</div>
              <div className="font-semibold text-base">{formatCurrency(subtotal)}</div>
            </div>
            <div className="flex items-center gap-2">
              {missingPriceCount > 0 && (
                <Badge variant="destructive" className="text-xs">
                  Some prices unavailable
                </Badge>
              )}
              <Button
                variant="secondary"
                size="sm"
                onClick={() => {
                  setIsDrawerOpen(false)
                  location.assign("/cart")
                }}
              >
                Go to Cart
              </Button>
              <SheetClose asChild>
                <Button variant="ghost" size="icon" aria-label="Close cart">
                  <X className="h-5 w-5" />
                </Button>
              </SheetClose>
            </div>
          </div>
        </div>

        <ScrollArea className="flex-1">
          <div className="px-3 py-2 space-y-3">
            {items.length === 0 && (
              <div className="p-6 text-center text-sm text-muted-foreground">
                Your cart is empty.
              </div>
            )}

            {items.map(it => (
              <div key={it.supplierItemId} className="rounded-lg border p-3">
                <div className="flex gap-3">
                  <div className="h-20 w-20 shrink-0 overflow-hidden rounded-md bg-muted">
                    {it.image ? (
                      <img src={it.image} alt="" className="h-full w-full object-contain" />
                    ) : null}
                  </div>

                  <div className="min-w-0 flex-1">
                    <div className="truncate font-medium">{it.displayName || it.itemName}</div>
                    {it.packSize ? (
                      <div className="text-xs text-muted-foreground">{it.packSize}</div>
                    ) : null}
                    {it.supplierName ? (
                      <div className="mt-0.5 text-xs text-muted-foreground">{it.supplierName}</div>
                    ) : null}

                    <div className="mt-2 text-sm font-semibold">
                      {formatCurrency(
                        includeVat
                          ? it.unitPriceIncVat ?? it.packPrice ?? 0
                          : it.unitPriceExVat ?? it.packPrice ?? 0,
                      )}
                    </div>

                    <div className="mt-2 inline-flex items-center gap-2">
                      <QuantityStepper
                        quantity={it.quantity}
                        onChange={qty =>
                          qty === 0
                            ? removeItem(it.supplierItemId)
                            : updateQuantity(it.supplierItemId, qty)
                        }
                        label={it.displayName || it.itemName}
                      />

                      <Button
                        variant="ghost"
                        size="icon"
                        aria-label={`Remove ${it.displayName || "item"}`}
                        className="ml-1 text-destructive hover:text-destructive"
                        onClick={() => removeItem(it.supplierItemId)}
                      >
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </ScrollArea>

        <div className="sticky bottom-0 z-10 border-t bg-background/95 backdrop-blur">
          <div className="flex items-center justify-between px-4 py-3">
            <div className="flex items-center gap-2 text-xs">
              <Button
                variant={!includeVat ? "default" : "outline"}
                size="sm"
                onClick={() => setIncludeVat(false)}
              >
                Ex VAT
              </Button>
              <Button
                variant={includeVat ? "default" : "outline"}
                size="sm"
                onClick={() => setIncludeVat(true)}
              >
                Inc VAT
              </Button>
            </div>
            <Button size="lg" className="min-w-[140px]" onClick={() => location.assign("/checkout")}>
              Checkout
            </Button>
          </div>
        </div>
      </SheetContent>
    </Sheet>
  )
}

export default CartDrawer


```


---

## src\components\cart\QuantityStepper.tsx

```tsx
import React, { useEffect, useState } from 'react'
import { Minus, Plus, Trash2 } from 'lucide-react'
import { cn } from '@/lib/utils'

interface QuantityStepperProps {
  quantity: number
  onChange: (qty: number) => void
  label: string
  /** Optional supplier name for accessibility labels */
  supplier?: string
  /** Optional callback when quantity should be removed */
  onRemove?: () => void
  min?: number
  max?: number
  className?: string
}

export function QuantityStepper({
  quantity,
  onChange,
  label,
  supplier,
  onRemove,
  min = 0,
  max = 9999,
  className,
}: QuantityStepperProps) {
  const [editing, setEditing] = useState(false)
  const [temp, setTemp] = useState(String(quantity))

  useEffect(() => {
    if (!editing) {
      setTemp(String(quantity))
    }
  }, [quantity, editing])

  const numericValue = Number(temp)
  const isInvalid = numericValue > max || numericValue < min

  const startEdit = () => {
    setEditing(true)
    setTemp(String(quantity))
  }

  const cancelEdit = () => {
    setEditing(false)
    setTemp(String(quantity))
  }

  const commitEdit = () => {
    const newQty = Math.min(max, Math.max(min, numericValue || 0))
    onChange(newQty)
    setEditing(false)
  }

  const handleInputKey = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter') {
      e.preventDefault()
      commitEdit()
    } else if (e.key === 'Escape') {
      e.preventDefault()
      cancelEdit()
    } else if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
      e.preventDefault()
      const delta = e.shiftKey ? 10 : 1
      const newVal = numericValue + (e.key === 'ArrowUp' ? delta : -delta)
      const clamped = Math.min(max, Math.max(min, newVal))
      setTemp(String(clamped))
    }
  }

  const itemLabel = supplier ? `${label} from ${supplier}` : label

  return (
    <div
      className={cn(
        'relative inline-flex h-7 w-[92px] md:w-[100px] items-center divide-x rounded-md border ring-offset-1 focus-within:ring-2 focus-within:ring-brand/50',
        (quantity === min || isInvalid) && 'border-destructive',
        className,
      )}
    >
      <button
        className="flex h-full w-7 items-center justify-center p-0 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand/50 disabled:opacity-50"
        aria-label={
          quantity === 1 ? `Remove ${itemLabel}` : `Decrease quantity of ${itemLabel}`
        }
        onClick={() =>
          quantity === 1 && onRemove
            ? onRemove()
            : onChange(Math.max(min, quantity - 1))
        }
        disabled={quantity === min}
      >
        {quantity === 1 ? (
          <Trash2 className="h-4 w-4 stroke-[1.5]" />
        ) : (
          <Minus className="h-4 w-4 stroke-[1.5]" />
        )}
      </button>
      {editing ? (
        <input
          aria-label={`Quantity of ${itemLabel}`}
          autoFocus
          inputMode="numeric"
          pattern="[0-9]*"
          className={cn(
            'h-full w-full bg-transparent text-center font-mono tabular-nums text-sm focus-visible:outline-none',
            isInvalid && 'text-destructive',
          )}
          value={temp}
          onChange={e => setTemp(e.target.value)}
          onFocus={e => e.target.select()}
          onBlur={commitEdit}
          onKeyDown={handleInputKey}
        />
      ) : (
        <span
          aria-label={`Quantity of ${itemLabel}`}
          tabIndex={0}
          onClick={startEdit}
          onKeyDown={e => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault()
              startEdit()
            }
          }}
          className="flex h-full flex-1 cursor-text items-center justify-center tabular-nums text-sm"
        >
          {quantity}
        </span>
      )}
      <button
        className="flex h-full w-7 items-center justify-center p-0 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand/50"
        aria-label={`Increase quantity of ${itemLabel}`}
        onClick={() => onChange(Math.min(max, quantity + 1))}
      >
        <Plus className="h-4 w-4 stroke-[1.5]" />
      </button>
      {isInvalid && (
        <span className="absolute -bottom-4 left-1/2 -translate-x-1/2 text-[10px] text-destructive">
          {numericValue < min ? `Min ${min}` : `Max ${max}`}
        </span>
      )}
    </div>
  )
}

export default QuantityStepper

```


---

## src\components\orders\OrderComposer.tsx

```tsx

import React, { useState } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { Separator } from '@/components/ui/separator'
import { Trash2, Plus, Minus, Truck } from 'lucide-react'
import { useDeliveryCalculation, useDeliveryOptimization } from '@/hooks/useDeliveryOptimization'
import { DeliveryOptimizationBanner } from '@/components/quick/DeliveryOptimizationBanner'
import { DeliveryFeeIndicator } from '@/components/delivery/DeliveryFeeIndicator'
import { OrderApprovalWorkflow } from './OrderApprovalWorkflow'
import { useToast } from '@/hooks/use-toast'
import { useCart } from '@/contexts/useBasket'
import { useSettings } from '@/contexts/useSettings'

export function OrderComposer() {
  const {
    items,
    updateQuantity,
    removeItem,
    clearCart,
    getTotalItems,
    getTotalPrice,
    getMissingPriceCount,
  } = useCart()
  const { includeVat } = useSettings()
  const { data: deliveryCalculations, isLoading: isLoadingDelivery } = useDeliveryCalculation()
  const { data: optimization } = useDeliveryOptimization()
  const { toast } = useToast()
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [orderApproved, setOrderApproved] = useState(false)

  const formatPrice = (price: number) => {
    return new Intl.NumberFormat('is-IS', {
      style: 'currency',
      currency: 'ISK',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(price)
  }

  const totalItems = getTotalItems()
  const subtotalPrice = getTotalPrice(includeVat)
  const missingPriceCount = getMissingPriceCount()
  const totalDeliveryFees = deliveryCalculations?.reduce((sum, calc) => sum + calc.total_delivery_cost, 0) || 0
  const grandTotal = subtotalPrice + totalDeliveryFees

  const handleOrderApproval = (reason?: string) => {
    setOrderApproved(true)
    toast({
      title: "Order Approved",
      description: reason || "Order approved for checkout despite delivery costs.",
    })
  }

  const handleOrderRejection = (reason: string) => {
    toast({
      title: "Order Rejected",
      description: reason,
      variant: "destructive"
    })
  }

  const handleCheckout = async () => {
    setIsSubmitting(true)
    try {
      // Here you would implement actual checkout logic
      toast({
        title: "Order Submitted",
        description: "Your order has been submitted successfully.",
      })
      clearCart()
      setOrderApproved(false)
    } catch (error) {
      toast({
        title: "Checkout Failed",
        description: "There was an error submitting your order.",
        variant: "destructive"
      })
    } finally {
      setIsSubmitting(false)
    }
  }

  if (items.length === 0) {
    return (
      <Card>
        <CardContent className="flex flex-col items-center justify-center py-12">
          <div className="text-muted-foreground text-center">
            <p className="text-lg mb-2">Your cart is empty</p>
            <p className="text-sm">Add items from the product comparison to get started</p>
          </div>
        </CardContent>
      </Card>
    )
  }

  // Group items by supplier
  const supplierGroups = items.reduce((groups, item) => {
    if (!groups[item.supplierId]) {
      groups[item.supplierId] = {
        supplierName: item.supplierName,
        items: []
      }
    }
    groups[item.supplierId].items.push(item)
    return groups
  }, {} as Record<string, { supplierName: string; items: typeof items }>)

  return (
    <div className="space-y-6">
      {/* Delivery Optimization Banner */}
      {optimization && (
        <DeliveryOptimizationBanner optimization={optimization} />
      )}

      {/* Order Approval Workflow */}
      {deliveryCalculations && !orderApproved && (
        <OrderApprovalWorkflow
          calculations={deliveryCalculations}
          onApprove={handleOrderApproval}
          onReject={handleOrderRejection}
          isSubmitting={isSubmitting}
        />
      )}

      {/* Order Items by Supplier */}
      {Object.entries(supplierGroups).map(([supplierId, group]) => {
        const supplierDelivery = deliveryCalculations?.find(calc => calc.supplier_id === supplierId)
        const supplierSubtotal = group.items.reduce((sum, item) => {
          const price = includeVat ? item.unitPriceIncVat : item.unitPriceExVat
          return sum + (price * item.quantity)
        }, 0)

        return (
          <Card key={supplierId}>
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-lg">{group.supplierName}</CardTitle>
                <div className="flex items-center gap-2">
                  {supplierDelivery && (
                    <DeliveryFeeIndicator calculation={supplierDelivery} />
                  )}
                  {supplierDelivery?.next_delivery_day && (
                    <Badge variant="outline" className="text-xs">
                      <Truck className="h-3 w-3 mr-1" />
                      Next: {supplierDelivery.next_delivery_day}
                    </Badge>
                  )}
                </div>
              </div>
            </CardHeader>
            
            <CardContent className="space-y-3">
              {group.items.map((item) => {
                const itemPrice = includeVat ? item.unitPriceIncVat : item.unitPriceExVat
                const lineTotal = itemPrice * item.quantity

                return (
                  <div key={item.supplierItemId} className="flex items-center justify-between p-3 bg-muted/30 rounded-lg">
                    <div className="flex-1 min-w-0">
                      <h4 className="font-medium text-sm truncate">{item.displayName}</h4>
                      <div className="flex items-center gap-2 text-xs text-muted-foreground mt-1">
                        <span>SKU: {item.sku}</span>
                        <span>•</span>
                        <span>{item.packSize}</span>
                        <span>•</span>
                        <span>{formatPrice(itemPrice)} per {item.unit}</span>
                      </div>
                    </div>

                    <div className="flex items-center gap-3">
                      <div className="text-right min-w-[80px]">
                        <div className="font-medium text-sm">
                          {formatPrice(lineTotal)}
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <div className="flex items-center w-[96px] gap-1">
                          <Button
                            size="sm"
                            variant="outline"
                            onClick={() =>
                              updateQuantity(
                                item.supplierItemId,
                                Math.max(1, item.quantity - 1),
                              )
                            }
                            className="h-6 w-6 p-0 rounded-md"
                          >
                            <Minus className="h-4 w-4" />
                          </Button>
                          <span className="w-10 text-center tabular-nums text-sm font-medium">
                            {item.quantity}
                          </span>
                          <Button
                            size="sm"
                            variant="outline"
                            onClick={() =>
                              updateQuantity(item.supplierItemId, item.quantity + 1)
                            }
                            className="h-6 w-6 p-0 rounded-md"
                          >
                            <Plus className="h-4 w-4" />
                          </Button>
                        </div>
                        <Button
                          size="sm"
                          variant="ghost"
                          onClick={() => removeItem(item.supplierItemId)}
                          className="h-6 w-6 p-0 rounded-md text-destructive hover:text-destructive flex items-center justify-center"
                        >
                          <Trash2 className="h-4 w-4" />
                        </Button>
                      </div>
                    </div>
                  </div>
                )
              })}

              {/* Supplier Summary */}
              <div className="pt-2 border-t space-y-2">
                <div className="flex justify-between text-sm">
                  <span>Items subtotal:</span>
                  <span>{formatPrice(supplierSubtotal)}</span>
                </div>
                
                {supplierDelivery && supplierDelivery.total_delivery_cost > 0 && (
                  <>
                    {supplierDelivery.delivery_fee > 0 && (
                      <div className="flex justify-between text-sm">
                        <span>Delivery fee:</span>
                        <span>{formatPrice(supplierDelivery.delivery_fee)}</span>
                      </div>
                    )}
                    
                    {supplierDelivery.fuel_surcharge > 0 && (
                      <div className="flex justify-between text-sm">
                        <span>Fuel surcharge:</span>
                        <span>{formatPrice(supplierDelivery.fuel_surcharge)}</span>
                      </div>
                    )}
                    
                    {supplierDelivery.pallet_deposit > 0 && (
                      <div className="flex justify-between text-sm">
                        <span>Pallet deposit:</span>
                        <span>{formatPrice(supplierDelivery.pallet_deposit)}</span>
                      </div>
                    )}
                  </>
                )}

                {supplierDelivery?.amount_to_free_delivery && (
                  <div className="text-xs text-blue-600 bg-blue-50 p-2 rounded">
                    Add {formatPrice(supplierDelivery.amount_to_free_delivery)} more for free delivery
                  </div>
                )}

                <div className="flex justify-between font-medium border-t pt-2">
                  <span>Supplier total:</span>
                  <span>{formatPrice(supplierSubtotal + (supplierDelivery?.total_delivery_cost || 0))}</span>
                </div>
              </div>
            </CardContent>
          </Card>
        )
      })}

      {/* Order Summary */}
      <Card>
        <CardHeader>
          <div className="flex items-center gap-2">
            <CardTitle>Order Summary</CardTitle>
            {missingPriceCount > 0 && (
              <Badge variant="destructive" className="text-xs">
                Some prices unavailable
              </Badge>
            )}
          </div>
        </CardHeader>
        <CardContent className="space-y-3">
          <div className="flex justify-between">
            <span>Items ({totalItems}):</span>
            <span>{formatPrice(subtotalPrice)}</span>
          </div>
          
          {totalDeliveryFees > 0 && (
            <div className="flex justify-between">
              <span>Total delivery fees:</span>
              <span>{formatPrice(totalDeliveryFees)}</span>
            </div>
          )}
          
          <Separator />
          
          <div className="flex justify-between text-lg font-semibold">
            <span>Grand total:</span>
            <span>{formatPrice(grandTotal)}</span>
          </div>
          
          <div className="pt-4 space-y-2">
            <Button 
              className="w-full" 
              size="lg"
              onClick={handleCheckout}
              disabled={isSubmitting || (!orderApproved && totalDeliveryFees > 10000)}
            >
              {isSubmitting ? 'Processing...' : 'Proceed to Checkout'}
            </Button>
            
            <Button 
              variant="outline" 
              className="w-full" 
              onClick={clearCart}
              disabled={isSubmitting}
            >
              Clear Cart
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}

```


---

## src\contexts\BasketProvider.tsx

```tsx
import React, { useEffect, useState } from 'react'
import { useToast } from '@/hooks/use-toast'
import type { CartItem } from '@/lib/types'
import { BasketContext } from './BasketProviderUtils'
import { ToastAction } from '@/components/ui/toast'
import { flyToCart } from '@/lib/flyToCart'
import { getCachedImageUrl } from '@/services/ImageCache'

export default function BasketProvider({ children }: { children: React.ReactNode }) {
  const [items, setItems] = useState<CartItem[]>(() => {
    const saved = localStorage.getItem('procurewise-basket')
    if (!saved) return []

    try {
      const parsed: any[] = JSON.parse(saved)

      // Migration: legacy basket entries only stored the product `name` field.
      // Ensure newer schema fields `itemName` and `displayName` are populated
      // when loading from localStorage for backward compatibility.
      return parsed.map(it => ({
        ...it,
        supplierItemId: it.supplierItemId ?? it.id,
        itemName:
          it.itemName ??
          it.name ??
          it.title ??
          it.productName,
        displayName:
          it.displayName ??
          it.itemName ??
          it.name ??
          it.title ??
          it.productName,
      }))
    } catch {
      return []
    }
  })

  const [isDrawerOpen, setIsDrawerOpen] = useState(false)
  const { toast } = useToast()

  // Sync basket across tabs
  useEffect(() => {
    const channel =
      typeof BroadcastChannel !== 'undefined'
        ? new BroadcastChannel('procurewise-basket')
        : null

    const handleMessage = (event: MessageEvent) => {
      if (event.data.type === 'BASKET_UPDATED') {
        setItems(event.data.items)
      }
    }

    channel?.addEventListener('message', handleMessage)
    return () => {
      channel?.removeEventListener('message', handleMessage)
      channel?.close()
    }
  }, [])

  // Fallback: cross-tab sync via storage events
  useEffect(() => {
    const onStorage = (e: StorageEvent) => {
        if (e.key === 'procurewise-basket' && e.newValue) {
          try {
            setItems(JSON.parse(e.newValue))
          } catch {
            /* ignore parse errors */
          }
        }
    }
    window.addEventListener('storage', onStorage)
    return () => window.removeEventListener('storage', onStorage)
  }, [])

  const syncBasket = (() => {
    let timeout: number | undefined
    let latest: CartItem[] = []
    const send = (items: CartItem[]) => {
      localStorage.setItem('procurewise-basket', JSON.stringify(items))
      if (typeof BroadcastChannel !== 'undefined') {
        const channel = new BroadcastChannel('procurewise-basket')
        channel.postMessage({ type: 'BASKET_UPDATED', items })
        channel.close()
      }
    }
    return (items: CartItem[]) => {
      latest = items
      if (timeout) window.clearTimeout(timeout)
      timeout = window.setTimeout(() => send(latest), 400)
    }
  })()

  const addItem = (
    item:
      | Omit<CartItem, 'quantity'>
      | { product_id: string; supplier_id: string; quantity?: number },
    quantity = 1,
    options: { showToast?: boolean; animateElement?: HTMLElement } = {}
  ) => {
    let normalizedItem: Omit<CartItem, 'quantity'>
    let finalQuantity = quantity

    if ('product_id' in item && 'supplier_id' in item) {
      normalizedItem = {
        id: item.product_id,
        supplierId: item.supplier_id,
        supplierName: '',
        itemName: 'Item',
        sku: '',
        packSize: '',
        packPrice: null,
        unitPriceExVat: null,
        unitPriceIncVat: null,
        vatRate: 0,
        unit: '',
        supplierItemId: item.product_id,
        displayName: 'Item',
        packQty: 1,
        image: null
      }
      if (item.quantity != null) {
        finalQuantity = item.quantity
      }
    } else {
      normalizedItem = {
        ...item,
        itemName: item.itemName ?? item.displayName ?? 'Item',
        displayName: item.displayName ?? item.itemName ?? 'Item',
        image: item.image ? getCachedImageUrl(item.image) : null
      }
    }

    const previousItems = items.map(i => ({ ...i }))
    if (options.animateElement) {
      flyToCart(options.animateElement)
    }
    setItems(prev => {
      const existingIndex = prev.findIndex(
        i => i.supplierItemId === normalizedItem.supplierItemId
      )

      let newItems: CartItem[]
      if (existingIndex >= 0) {
        newItems = prev.map((basketItem, index) =>
          index === existingIndex
            ? { ...basketItem, quantity: basketItem.quantity + finalQuantity }
            : basketItem
        )
      } else {
        newItems = [...prev, { ...normalizedItem, quantity: finalQuantity }]
      }

      syncBasket(newItems)

      if (options.showToast !== false) {
        toast({
          description: `Added ${normalizedItem.itemName} × ${finalQuantity}`,
          action: (
            <ToastAction altText="Undo" onClick={() => restoreItems(previousItems)}>
              Undo
            </ToastAction>
          )
        })
      }

      return newItems
    })
  }

  const updateQuantity = (supplierItemId: string, quantity: number) => {
    if (quantity < 1) {
      removeItem(supplierItemId)
      return
    }
    setItems(prev => {
      const newQuantity = Math.max(1, quantity)
      const newItems = prev.map(item =>
        item.supplierItemId === supplierItemId
          ? { ...item, quantity: newQuantity }
          : item
      )
      syncBasket(newItems)
      return newItems
    })
  }

  const removeItem = (supplierItemId: string) => {
    setItems(prev => {
      const previousItems = prev.map(i => ({ ...i }))
      const removed = prev.find(i => i.supplierItemId === supplierItemId)
      const newItems = prev.filter(item => item.supplierItemId !== supplierItemId)
      syncBasket(newItems)
      if (removed) {
        toast({
          description: `${removed.itemName} removed from cart`,
          action: (
            <ToastAction altText="Undo" onClick={() => restoreItems(previousItems)}>
              Undo
            </ToastAction>
          ),
        })
      }
      return newItems
    })
  }

  const clearBasket = () => {
    setItems([])
    syncBasket([])
  }

  const restoreItems = (items: CartItem[]) => {
    setItems(items)
    syncBasket(items)
  }

  // Add clearCart method for backward compatibility
  const clearCart = clearBasket

  const getTotalItems = () => {
    return items.reduce((total, item) => total + item.quantity, 0)
  }

  const getTotalPrice = (includeVat: boolean): number => {
    return items.reduce((total, item) => {
      const price = includeVat ? item.unitPriceIncVat : item.unitPriceExVat
      return total + ((price ?? 0) * item.quantity)
    }, 0)
  }

  const getMissingPriceCount = () =>
    items.filter(i => i.unitPriceIncVat == null && i.unitPriceExVat == null).length

  return (
    <BasketContext.Provider value={{
      items,
      addItem,
      updateQuantity,
      removeItem,
      clearBasket,
      clearCart,
      restoreItems,
      getTotalItems,
      getTotalPrice,
      getMissingPriceCount,
      isDrawerOpen,
      setIsDrawerOpen
    }}>
      {children}
    </BasketContext.Provider>
  )
}


```


---

## src\contexts\useBasket.ts

```ts
import { useContext } from 'react'
import { BasketContext } from './BasketProviderUtils'

export function useBasket() {
  const context = useContext(BasketContext)
  if (context === undefined) {
    throw new Error('useBasket must be used within a BasketProvider')
  }
  return context
}

export const useCart = useBasket

```


---

## src\hooks\useDeliveryOptimization.tsx

```tsx

import { useQuery } from '@tanstack/react-query'
import { useCart } from '@/contexts/useBasket'
import { deliveryCalculator } from '@/services/DeliveryCalculator'
import type { DeliveryCalculation, OrderDeliveryOptimization } from '@/lib/types/delivery'

export function useDeliveryCalculation() {
  const { items } = useCart()
  const key = items
    .map(i => `${i.supplierId}:${i.supplierItemId}:${i.quantity}`)
    .sort()
    .join('|')

  return useQuery({
    queryKey: ['delivery-calculation', key],
    queryFn: () => deliveryCalculator.calculateOrderDelivery(items),
    enabled: items.length > 0,
    staleTime: 2 * 60 * 1000, // 2 minutes
  })
}

export function useDeliveryOptimization() {
  const { items } = useCart()
  const key = items
    .map(i => `${i.supplierId}:${i.supplierItemId}:${i.quantity}`)
    .sort()
    .join('|')

  return useQuery({
    queryKey: ['delivery-optimization', key],
    queryFn: () => deliveryCalculator.optimizeOrder(items),
    enabled: items.length > 0,
    staleTime: 2 * 60 * 1000, // 2 minutes
  })
}

```


---

## src\hooks\useOrderingSuggestions.tsx

```tsx

import { useQuery } from '@tanstack/react-query'
import { useCart } from '@/contexts/useBasket'
import { orderingSuggestions } from '@/services/OrderingSuggestions'

export function useOrderingSuggestions() {
  const { items } = useCart()
  const key = items
    .map(i => `${i.supplierId}:${i.supplierItemId}:${i.quantity}`)
    .sort()
    .join('|')

  return useQuery({
    queryKey: ['ordering-suggestions', key],
    queryFn: () => orderingSuggestions.generateSuggestions(items),
    enabled: items.length > 0,
    staleTime: 1 * 60 * 1000, // 1 minute
  })
}

```


---

## src\index.css

```css

@import 'tailwindcss/base';
@import 'tailwindcss/components';
@import 'tailwindcss/utilities';

@import './styles/globals.css';
@import './styles/design-system.css';
@import './styles/layout-vars.css';

@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&display=swap');

:root{
  --font-ui: "Red Hat Text", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  --font-display: "Red Hat Display", var(--font-ui);

  /* type scale (tweak if needed) */
  --fs-h1: 28px; --fs-h2: 22px; --fs-h3: 18px; --fs-body: 15px; --fs-meta: 13px;
}

/* Defaults */
html { font-family: var(--font-ui); font-size: 15px; }
body { font-variant-numeric: normal; }

/* Headings / nav “brand voice” */
h1,h2,h3,.display { font-family: var(--font-display); font-weight: 600; letter-spacing: -0.005em; }
h1{ font-size: var(--fs-h1); } h2{ font-size: var(--fs-h2); } h3{ font-size: var(--fs-h3); }

/* UI text */
p,li,button,input,select,textarea,table { font-size: var(--fs-body); }
.meta, small { font-size: var(--fs-meta); opacity:.9; }

/* Import our comprehensive design system */

/* Ensure no default margins/padding for clean layout */
html, body, #root {
  margin: 0;
  padding: 0;
  height: 100%;
}

/* Set a fallback header height so content can offset correctly */
:root {
  --sidebar-w: 256px; /* expanded width */
  --sidebar-rail-w: 48px; /* collapsed rail width */
  --header-right: 0px; /* reserved for symmetry */
}

@media (max-width: 1024px) {
  :root {
    --header-left: 0px;
  }
}

/* Header should start to the right of the sidebar */
[data-app-header="true"] {
  position: static;
  left: auto;
  width: auto;
}

body {
  @apply m-0 p-0;
  scroll-padding-top: var(--chrome-h);
}

#root {
  max-width: none !important;
  margin: 0 !important;
  padding: 0 !important;
}

/* If no overlay is actively locking scroll, ensure no ghost gutter on body */
body:not([data-scroll-locked]) {
  padding-right: 0 !important;
  margin-right: 0 !important;
}

main > *:first-child {
  margin-top: 0;
}

html { scrollbar-gutter: stable; }

#catalogHeader {
  --hdr-h: var(--header-h, 56px);
  transform: translateY(calc(-1 * var(--hdr-p, 0) * var(--hdr-h)));
  transition: transform 180ms ease;
  will-change: transform;
}

#catalogHeader::before {
  /* Remove pseudo-element overlay that obscured the page */
  content: none !important;
}

@media (prefers-reduced-motion: reduce){
  #catalogHeader{ transition:none; }
}

/* 1) Ensure header is to the right of the sidebar */
[data-app-header="true"],
.app-header,
#catalogHeader {
  position: sticky;
  top: 0;
  left: var(--header-left, 0px);
  width: calc(100% - var(--header-left, 0px));
  z-index: 40;
}


```


---

## src\lib\flyToCart.ts

```ts
export function flyToCart(source: HTMLElement, target?: HTMLElement) {
  try {
    if (
      typeof window !== 'undefined' &&
      window.matchMedia?.('(prefers-reduced-motion: reduce)').matches
    ) {
      return
    }

    const cart = target || (document.getElementById('mini-cart-button') as HTMLElement | null);
    if (!source || !cart) return;

    const start = source.getBoundingClientRect();
    const end = cart.getBoundingClientRect();

    const clone = source.cloneNode(true) as HTMLElement;
    clone.style.position = 'fixed';
    clone.style.left = `${start.left}px`;
    clone.style.top = `${start.top}px`;
    clone.style.width = `${start.width}px`;
    clone.style.height = `${start.height}px`;
    clone.style.pointerEvents = 'none';
    clone.style.zIndex = '1000';
    clone.style.transition = 'transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.25s';
    document.body.appendChild(clone);

    const translateX = end.left - start.left;
    const translateY = end.top - start.top;

    requestAnimationFrame(() => {
      clone.style.transform = `translate(${translateX}px, ${translateY}px) scale(0.3)`;
      clone.style.opacity = '0';
    });

    clone.addEventListener('transitionend', () => {
      clone.remove();
    });
  } catch {
    // Fail silently if animation cannot run
  }
}

```


---

## src\services\DeliveryCalculator.ts

```ts

import { supabase } from '@/integrations/supabase/client'
import type { CartItem } from '@/lib/types'
import type { 
  DeliveryRule, 
  DeliveryCalculation, 
  OrderDeliveryOptimization,
  DeliveryOptimizationSuggestion,
  DeliveryWarning
} from '@/lib/types/delivery'

export class DeliveryCalculator {
  private deliveryRules: Map<string, DeliveryRule> = new Map()
  private lastRulesFetch = 0
  private readonly CACHE_DURATION = 5 * 60 * 1000 // 5 minutes

  async getDeliveryRules(): Promise<Map<string, DeliveryRule>> {
    const now = Date.now()
    
    if (now - this.lastRulesFetch > this.CACHE_DURATION) {
      const { data } = await (supabase as any)
        .from('delivery_rules')
        .select('*')
        .eq('is_active', true)

      if (data) {
        this.deliveryRules.clear();
        (data as DeliveryRule[]).forEach(rule => {
          this.deliveryRules.set(rule.supplier_id, rule)
        })
        this.lastRulesFetch = now
      }
    }

    return this.deliveryRules
  }

  async calculateDeliveryForSupplier(
    supplierId: string,
    supplierName: string,
    items: CartItem[],
    zone = 'default'
  ): Promise<DeliveryCalculation> {
    const rules = await this.getDeliveryRules()
    const rule = rules.get(supplierId)

    const subtotalExVat = items.reduce((sum, item) => {
      const p = item.unitPriceExVat ?? item.unitPriceIncVat ?? 0
      return sum + (p * item.quantity)
    }, 0)

    if (!rule) {
      return {
        supplier_id: supplierId,
        supplier_name: supplierName,
        subtotal_ex_vat: subtotalExVat,
        delivery_fee: 0,
        fuel_surcharge: 0,
        pallet_deposit: 0,
        total_delivery_cost: 0,
        landed_cost: subtotalExVat,
        is_under_threshold: false,
        threshold_amount: null,
        amount_to_free_delivery: null,
        next_delivery_day: null
      }
    }

    // Calculate delivery fee
    let deliveryFee = 0
    const isUnderThreshold = rule.free_threshold_ex_vat && subtotalExVat < rule.free_threshold_ex_vat

    if (isUnderThreshold) {
      // Check for tiered pricing
      if (rule.tiers_json && rule.tiers_json.length > 0) {
        const applicableTiers = rule.tiers_json
          .filter(tier => subtotalExVat >= tier.threshold)
          .sort((a, b) => b.threshold - a.threshold)
        
        deliveryFee = applicableTiers.length > 0 ? applicableTiers[0].fee : rule.flat_fee
      } else {
        deliveryFee = rule.flat_fee
      }
    }

    // Calculate surcharges
    const fuelSurcharge = subtotalExVat * (rule.fuel_surcharge_pct / 100)
    const totalPacks = items.reduce((sum, item) => sum + item.quantity, 0)
    const palletDeposit = totalPacks * rule.pallet_deposit_per_unit

    const totalDeliveryCost = deliveryFee + fuelSurcharge + palletDeposit
    const landedCost = subtotalExVat + totalDeliveryCost

    const amountToFreeDelivery = rule.free_threshold_ex_vat && isUnderThreshold
      ? rule.free_threshold_ex_vat - subtotalExVat
      : null

    return {
      supplier_id: supplierId,
      supplier_name: supplierName,
      subtotal_ex_vat: subtotalExVat,
      delivery_fee: deliveryFee,
      fuel_surcharge: fuelSurcharge,
      pallet_deposit: palletDeposit,
      total_delivery_cost: totalDeliveryCost,
      landed_cost: landedCost,
      is_under_threshold: Boolean(isUnderThreshold),
      threshold_amount: rule.free_threshold_ex_vat,
      amount_to_free_delivery: amountToFreeDelivery,
      next_delivery_day: this.getNextDeliveryDay(rule.delivery_days)
    }
  }

  async calculateOrderDelivery(cartItems: CartItem[]): Promise<DeliveryCalculation[]> {
    // Group items by supplier
    const supplierGroups = new Map<string, { name: string; items: CartItem[] }>()
    
    cartItems.forEach(item => {
      if (!supplierGroups.has(item.supplierId)) {
        supplierGroups.set(item.supplierId, {
          name: item.supplierName,
          items: []
        })
      }
      supplierGroups.get(item.supplierId)!.items.push(item)
    })

    const calculations: DeliveryCalculation[] = []
    
    for (const [supplierId, group] of supplierGroups) {
      const calculation = await this.calculateDeliveryForSupplier(
        supplierId,
        group.name,
        group.items
      )
      calculations.push(calculation)
    }

    return calculations
  }

  async optimizeOrder(cartItems: CartItem[]): Promise<OrderDeliveryOptimization> {
    const currentCalculations = await this.calculateOrderDelivery(cartItems)
    const currentTotal = currentCalculations.reduce((sum, calc) => sum + calc.landed_cost, 0)

    const suggestions: DeliveryOptimizationSuggestion[] = []
    const warnings: DeliveryWarning[] = []

    // Generate top-up suggestions
    for (const calc of currentCalculations) {
      if (calc.is_under_threshold && calc.amount_to_free_delivery) {
        suggestions.push({
          type: 'top_up',
          supplier_id: calc.supplier_id,
          supplier_name: calc.supplier_name,
          description: `Add ISK${Math.ceil(calc.amount_to_free_delivery).toLocaleString()} more to reach free delivery`,
          savings: calc.delivery_fee,
          items: [] // Would be populated with suggested items from pantry/favorites
        })
      }
    }

    // Generate warnings for new suppliers with fees
    for (const calc of currentCalculations) {
      if (calc.total_delivery_cost > 0) {
        warnings.push({
          type: 'new_supplier_fee',
          supplier_id: calc.supplier_id,
          supplier_name: calc.supplier_name,
          message: `Adding items from ${calc.supplier_name} will incur ISK${Math.ceil(calc.total_delivery_cost).toLocaleString()} delivery fee`,
          cost_impact: calc.total_delivery_cost
        })
      }
    }

    return {
      current_total: currentTotal,
      optimized_total: currentTotal, // Would be calculated with optimizations applied
      savings: 0, // Would be calculated
      suggestions,
      warnings
    }
  }

  private getNextDeliveryDay(deliveryDays: number[]): string | null {
    if (!deliveryDays || deliveryDays.length === 0) return null

    const today = new Date()
    const currentDay = today.getDay() === 0 ? 7 : today.getDay() // Convert Sunday from 0 to 7

    // Find next available delivery day
    const sortedDays = [...deliveryDays].sort((a, b) => a - b)
    const nextDay = sortedDays.find(day => day > currentDay) || sortedDays[0]

    const daysUntilDelivery = nextDay > currentDay 
      ? nextDay - currentDay 
      : 7 - currentDay + nextDay

    const deliveryDate = new Date(today)
    deliveryDate.setDate(today.getDate() + daysUntilDelivery)

    return deliveryDate.toLocaleDateString('is-IS', { 
      weekday: 'short', 
      month: 'short', 
      day: 'numeric' 
    })
  }
}

export const deliveryCalculator = new DeliveryCalculator()

```
